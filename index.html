<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPS - Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¹Ø§Ù…</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #8e44ad; --secondary: #2ecc71; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 95%; max-width: 450px; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid #ddd; box-sizing: border-box; }
        .btn-main { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .profile-preview { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; margin: 10px auto; display: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
        #printable-card { 
            width: 350px; height: 210px; border: 2px solid var(--primary); border-radius: 15px; 
            margin: 20px auto; display: none; background: white; text-align: right; overflow: hidden;
        }
        .card-top { background: var(--primary); color: white; padding: 5px; text-align: center; font-weight: bold; }
        .card-content { display: flex; padding: 10px; gap: 10px; }
        .card-img { width: 90px; height: 110px; border-radius: 8px; border: 1px solid #ddd; object-fit: cover; }
        
        @media print {
            body * { visibility: hidden; }
            #printable-card, #printable-card * { visibility: visible; }
            #printable-card { position: absolute; left: 0; top: 0; display: block !important; }
        }
    </style>
</head>
<body>

<div class="container" id="main-container">
    <div id="login-view">
        <img src="1000219663.jpg" style="width:120px; margin-bottom:10px;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/9131/9131529.png'">
        <h2 style="color:var(--primary); margin:0;">IPS</h2>
        <p style="font-size:12px; color:#666;">Ø¥Ø´Ø±Ø§Ù Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ø¨Ù† Ø®Ù„Ø¯ÙˆÙ†</p>
        <input type="text" id="id-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ">
        <input type="password" id="pass-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn-main" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        <p onclick="toggleView('reg')" style="color:var(--primary); cursor:pointer; font-size:14px;">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</p>
    </div>

    <div id="reg-view" style="display:none;">
        <h3 style="color:var(--primary)">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ IPS</h3>
        <input type="file" accept="image/*" id="file-input" onchange="handleImg(this)">
        <img id="img-render" class="profile-preview">
        <div class="grid">
            <input type="text" id="r-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="number" id="r-id" placeholder="ID (04... Ù„Ù„Ù…Ø´Ø±Ù)">
            <input type="text" id="r-father" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø¨">
            <input type="tel" id="r-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <input type="password" id="r-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <input type="text" id="r-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        </div>
        <button class="btn-main" id="reg-btn" onclick="register()">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹</button>
        <button onclick="toggleView('login')" style="background:none; border:none; color:#666; cursor:pointer;">Ø±Ø¬ÙˆØ¹</button>
    </div>

    <div id="profile-view" style="display:none;">
        <img id="u-photo" class="profile-preview" style="display:block;">
        <h2 id="u-name">---</h2>
        <p id="u-role" style="color:#888;">---</p>
        <button class="btn-main" style="background:var(--secondary)" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
        
        <div id="admin-tools" style="display:none; margin-top:20px; border-top:2px solid #eee; padding-top:15px;">
            <h4 style="text-align:right;">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù:</h4>
            <div id="students-list" style="text-align:right; font-size:14px;"></div>
        </div>
        
        <button class="btn-main" style="background:#e74c3c; margin-top:20px;" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<div id="printable-card">
    <div class="card-top">IPS - Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ø¨Ù† Ø®Ù„Ø¯ÙˆÙ†</div>
    <div class="card-content">
        <img id="c-img" class="card-img" src="">
        <div style="flex:1; font-size:12px;">
            <b>Ø§Ù„Ø§Ø³Ù…:</b> <span id="c-name"></span><br>
            <b>Ø§Ù„Ù€ ID:</b> <span id="c-id"></span><br>
            <b>Ø§Ù„ØµÙØ©:</b> <span id="c-role"></span><br>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=50x50&data=IPS_IbnKhaldon" style="margin-top:15px; width:45px;">
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://ips-khaldon-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let userImgBase64 = "";

    function handleImg(input) {
        const reader = new FileReader();
        reader.onload = e => { 
            userImgBase64 = e.target.result; 
            document.getElementById('img-render').src = userImgBase64;
            document.getElementById('img-render').style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
    }

    function toggleView(view) {
        document.getElementById('login-view').style.display = view === 'login' ? 'block' : 'none';
        document.getElementById('reg-view').style.display = view === 'reg' ? 'block' : 'none';
    }

    function register() {
        const id = document.getElementById('r-id').value;
        const name = document.getElementById('r-name').value;
        const pass = document.getElementById('r-pass').value;

        if(!id || !name || !pass) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        let type = id.startsWith("04") ? "admin" : (id.startsWith("2026") ? "student" : "");
        if(!type) return alert("Ø§Ù„Ù€ ID ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 04 Ù„Ù„Ù…Ø´Ø±Ù Ø£Ùˆ 2026 Ù„Ù„Ø·Ø§Ù„Ø¨");

        let role = type === "admin" ? "Ù…Ø´Ø±Ù Ø¥Ø¯Ø§Ø±ÙŠ" : (id <= 202610 ? "Ø·Ø§Ù„Ø¨ - ØªØ§Ø³Ø¹" : id <= 202620 ? "Ø·Ø§Ù„Ø¨ - Ø¹Ø§Ø´Ø±" : "Ø·Ø§Ù„Ø¨ - Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±");

        const userData = {
            name: name, id: id, pass: pass, photo: userImgBase64 || "https://cdn-icons-png.flaticon.com/512/9131/9131529.png",
            role: role, type: type, phone: document.getElementById('r-phone').value, father: document.getElementById('r-father').value
        };

        document.getElementById('reg-btn').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
        db.ref('users/' + id).set(userData).then(() => {
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ IPS Ø¨Ù†Ø¬Ø§Ø­!");
            location.reload();
        }).catch(err => alert("Ø®Ø·Ø£: " + err.message));
    }

    function login() {
        const id = document.getElementById('id-input').value;
        const ps = document.getElementById('pass-input').value;
        db.ref('users/' + id).once('value').then(snap => {
            const u = snap.val();
            if(u && u.pass === ps) showProfile(u); else alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©");
        });
    }

    function showProfile(u) {
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('profile-view').style.display = 'block';
        document.getElementById('u-name').innerText = u.name;
        document.getElementById('u-photo').src = u.photo;
        document.getElementById('u-role').innerText = u.role;
        document.getElementById('c-name').innerText = u.name;
        document.getElementById('c-id').innerText = u.id;
        document.getElementById('c-role').innerText = u.role;
        document.getElementById('c-img').src = u.photo;

        if(u.type === 'admin') {
            document.getElementById('admin-tools').style.display = 'block';
            db.ref('users').on('value', s => {
                let list = "";
                for(let key in s.val()) {
                    if(s.val()[key].type === 'student') list += `<div>â€¢ ${s.val()[key].name} (${s.val()[key].role})</div>`;
                }
                document.getElementById('students-list').innerHTML = list || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨";
            });
        }
    }
</script>
</body>
</html>
