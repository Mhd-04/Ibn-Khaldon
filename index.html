<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ø¨Ù† Ø®Ù„Ø¯ÙˆÙ† Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #8e44ad; --bg: #f4f7fe; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; text-align: center; }
        .card { background: white; border-radius: 20px; padding: 25px; margin: 20px auto; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        .btn-purple { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .profile-img { width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; }
        .student-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .badge { padding: 5px 10px; border-radius: 5px; color: white; font-size: 12px; }
    </style>
</head>
<body>

<div id="auth-page">
    <div class="card" id="login-box">
        <img src="1000219663.jpg" style="width:120px;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/9131/9131529.png'">
        <h2 style="color:var(--primary)">IPS</h2>
        <input type="text" id="log-id" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ">
        <input type="password" id="log-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn-purple" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
        <p style="cursor:pointer; color:var(--primary); font-size:14px;" onclick="showReg(true)">Ø£Ù„Ø§ ØªÙ…Ù„Ùƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</p>
    </div>

    <div class="card" id="reg-box" style="display:none;">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
        <input type="file" accept="image/*" onchange="previewImg(this)">
        <img id="prev" class="profile-img" style="display:none; margin: 10px auto;">
        <input type="text" id="r-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        <input type="number" id="r-id" placeholder="Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ">
        <input type="password" id="r-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <select id="r-type" style="width:100%; padding:10px; margin:5px 0; border-radius:10px;">
            <option value="student">Ø·Ø§Ù„Ø¨</option>
            <option value="admin">Ù…ÙˆØ¬Ù‡ / Ù…Ø´Ø±Ù</option>
        </select>
        <button class="btn-purple" onclick="handleRegister()">Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹</button>
        <button onclick="showReg(false)">Ø±Ø¬ÙˆØ¹</button>
    </div>
</div>

<div id="app-page" style="display:none;">
    <div class="card">
        <img id="u-img" class="profile-img" src="">
        <h2 id="u-name">---</h2>
        <p id="u-role" style="color:#666">---</p>
    </div>

    <div id="admin-view" class="card" style="display:none;">
        <h3>ğŸ“š Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØµÙ†ÙØ©</h3>
        <div id="st-list">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>

    <div id="student-view" class="card" style="display:none;">
        <h3>ğŸ“ Ù‚Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØµÙØ­ØªÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©.</p>
    </div>
    
    <button class="card" style="width:auto; padding:10px 40px;" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://ips-khaldon-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let userImg = "";

    function previewImg(input) {
        const reader = new FileReader();
        reader.onload = e => { 
            userImg = e.target.result; 
            document.getElementById('prev').src = userImg;
            document.getElementById('prev').style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
    }

    function showReg(s) {
        document.getElementById('login-box').style.display = s ? 'none' : 'block';
        document.getElementById('reg-box').style.display = s ? 'block' : 'none';
    }

    function handleRegister() {
        const id = document.getElementById('r-id').value;
        const type = document.getElementById('r-type').value;
        const data = {
            name: document.getElementById('r-name').value,
            id: id,
            pass: document.getElementById('r-pass').value,
            type: type,
            photo: userImg || 'https://cdn-icons-png.flaticon.com/512/9131/9131529.png',
            grade: (id >= 202601 && id <= 202610) ? "ØªØ§Ø³Ø¹" : (id <= 202620) ? "Ø¹Ø§Ø´Ø±" : "Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±"
        };

        if(!id || !data.pass) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        db.ref('users/' + id).set(data).then(() => {
            alert("ØªÙ… Ø§Ù„Ø­ÙØ¸! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ ID: " + id);
            location.reload();
        });
    }

    function handleLogin() {
        const id = document.getElementById('log-id').value;
        const ps = document.getElementById('log-pass').value;

        // Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…
        db.ref('users/' + id).once('value').then(snap => {
            const u = snap.val();
            if (u && u.pass === ps) {
                launchApp(u);
            } else if (id === "ibn khaldon" && ps === "ITmohammedf0@") {
                // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù„Ù„Ù…ÙˆØ¬Ù‡
                launchApp({name: "Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø¹Ø§Ù…", type: "admin", photo: ""});
            } else {
                alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ù€ ID Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
            }
        });
    }

    function launchApp(u) {
        document.getElementById('auth-page').style.display = 'none';
        document.getElementById('app-page').style.display = 'block';
        document.getElementById('u-name').innerText = u.name;
        document.getElementById('u-img').src = u.photo || 'https://cdn-icons-png.flaticon.com/512/9131/9131529.png';
        document.getElementById('u-role').innerText = (u.type === 'admin') ? "Ù…ÙˆØ¬Ù‡ / Ù…Ø´Ø±Ù" : "Ø·Ø§Ù„Ø¨ - " + u.grade;

        if (u.type === 'admin') {
            document.getElementById('admin-view').style.display = 'block';
            loadStudents();
        } else {
            document.getElementById('student-view').style.display = 'block';
        }
    }

    function loadStudents() {
        db.ref('users').on('value', snap => {
            const users = snap.val();
            let html = "";
            for (let id in users) {
                if (users[id].type === 'student') {
                    html += `<div class="student-item">
                        <img src="${users[id].photo}" style="width:40px;height:40px;border-radius:50%">
                        <div style="flex:1; margin-right:10px; text-align:right;">
                            <b>${users[id].name}</b><br><small>ID: ${id}</small>
                        </div>
                        <span class="badge" style="background:${users[id].grade=='ØªØ§Ø³Ø¹'?'#3498db':users[id].grade=='Ø¹Ø§Ø´Ø±'?'#2ecc71':'#e67e22'}">${users[id].grade}</span>
                    </div>`;
                }
            }
            document.getElementById('st-list').innerHTML = html || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙˆÙ† Ø¨Ø¹Ø¯.";
        });
    }
</script>
</body>
</html>
