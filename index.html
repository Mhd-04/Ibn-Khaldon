<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… IPS - Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #8e44ad; --bg: #f4f7fe; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .card { width: 90%; max-width: 420px; background: white; padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; }
        input, button, select { width: 100%; padding: 12px; margin: 6px 0; border-radius: 12px; border: 1px solid #eee; box-sizing: border-box; }
        .btn-main { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        .btn-print { background: #2ecc71; color: white; border: none; padding: 10px; border-radius: 10px; cursor: pointer; margin-top: 10px; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
        #id-card-print { 
            width: 350px; height: 220px; border: 2px solid var(--primary); border-radius: 15px; 
            margin: 20px auto; display: none; background: white; position: relative; overflow: hidden; text-align: right;
        }
        .card-header { background: var(--primary); color: white; padding: 5px; text-align: center; font-size: 14px; font-weight: bold; }
        .card-body { display: flex; padding: 10px; gap: 10px; }
        .card-photo { width: 90px; height: 110px; border: 2px solid #eee; object-fit: cover; border-radius: 8px; }
        .card-info { flex: 1; font-size: 13px; line-height: 1.6; }
        
        @media print {
            body * { visibility: hidden; }
            #id-card-print, #id-card-print * { visibility: visible; }
            #id-card-print { position: absolute; left: 0; top: 0; display: block !important; }
        }
    </style>
</head>
<body>

<div id="auth-container" class="card">
    <div id="login-form">
        <img src="1000219663.jpg" style="width:100px;">
        <h2>Ù†Ø¸Ø§Ù… IPS</h2>
        <input type="text" id="l-id" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù€ ID">
        <input type="password" id="l-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn-main" onclick="doLogin()">Ø¯Ø®ÙˆÙ„</button>
        <p onclick="toggleReg(true)" style="cursor:pointer; color:var(--primary)">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</p>
    </div>

    <div id="reg-form" style="display:none;">
        <input type="file" accept="image/*" onchange="readImg(this)">
        <img id="p-prev" src="" style="width:80px; display:none; margin:auto; border-radius:50%">
        <input type="text" id="r-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        <input type="number" id="r-id" placeholder="ID (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 2026 Ø£Ùˆ 04)">
        <input type="password" id="r-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn-main" onclick="doRegister()">Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        <button onclick="toggleReg(false)">Ø±Ø¬ÙˆØ¹</button>
    </div>
</div>

<div id="app-page" class="card" style="display:none;">
    <img id="u-img" src="" style="width:80px; border-radius:50%">
    <h3 id="u-name">---</h3>
    <p id="u-role">---</p>
    
    <button class="btn-print" onclick="printIDCard()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</button>

    <div id="admin-only" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
        <h4>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¬Ù‡</h4>
        <button class="btn-main" style="background:#34495e" onclick="window.print()">ğŸ“‹ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„Ø·Ù„Ø§Ø¨</button>
        <div id="st-list" style="margin-top:10px; text-align:right;"></div>
    </div>
</div>

<div id="id-card-print">
    <div class="card-header">Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ø¨Ù† Ø®Ù„Ø¯ÙˆÙ† Ø§Ù„Ø®Ø§ØµØ© - Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¯Ø±Ø³ÙŠØ©</div>
    <div class="card-body">
        <img id="c-img" class="card-photo" src="">
        <div class="card-info">
            <b>Ø§Ù„Ø§Ø³Ù…:</b> <span id="c-name"></span><br>
            <b>Ø§Ù„Ù€ ID:</b> <span id="c-id"></span><br>
            <b>Ø§Ù„ØµÙØ©:</b> <span id="c-role"></span><br>
            <div style="margin-top:10px; font-size:10px; color:var(--primary)">Ù†Ø¸Ø§Ù… IPS Ø§Ù„Ù…Ø·ÙˆØ± Â© 2026</div>
        </div>
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=50x50&data=IbnKhaldon" style="width:50px; height:50px; align-self:flex-end;">
    </div>
</div>

<script>
    const conf = { databaseURL: "https://ips-khaldon-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(conf);
    const db = firebase.database();
    let pic = "";

    function readImg(i) {
        const r = new FileReader();
        r.onload = e => { pic = e.target.result; document.getElementById('p-prev').src = pic; document.getElementById('p-prev').style.display='block'; };
        r.readAsDataURL(i.files[0]);
    }

    function toggleReg(s) { document.getElementById('login-form').style.display=s?'none':'block'; document.getElementById('reg-form').style.display=s?'block':'none'; }

    function doRegister() {
        const id = document.getElementById('r-id').value;
        const role = id.startsWith("04") ? "Ù…ÙˆØ¬Ù‡ Ø¥Ø¯Ø§Ø±ÙŠ" : (id<=202610?"ØªØ§Ø³Ø¹":id<=202620?"Ø¹Ø§Ø´Ø±":"Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±");
        const data = { name: document.getElementById('r-name').value, id: id, pass: document.getElementById('r-pass').value, photo: pic, role: role, type: id.startsWith("04")?'admin':'student' };
        db.ref('users/'+id).set(data).then(() => location.reload());
    }

    function doLogin() {
        const id = document.getElementById('l-id').value;
        const ps = document.getElementById('l-pass').value;
        db.ref('users/'+id).once('value').then(snap => {
            const u = snap.val();
            if(u && u.pass === ps) launch(u); else alert("Ø®Ø·Ø£!");
        });
    }

    function launch(u) {
        document.getElementById('auth-container').style.display='none';
        document.getElementById('app-page').style.display='block';
        document.getElementById('u-name').innerText = u.name;
        document.getElementById('u-img').src = u.photo;
        document.getElementById('u-role').innerText = u.role;

        // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
        document.getElementById('c-name').innerText = u.name;
        document.getElementById('c-id').innerText = u.id;
        document.getElementById('c-role').innerText = u.role;
        document.getElementById('c-img').src = u.photo;

        if(u.type === 'admin') {
            document.getElementById('admin-only').style.display='block';
            db.ref('users').on('value', s => {
                let h = "";
                for(let k in s.val()) if(s.val()[k].type==='student') h += `<div>â€¢ ${s.val()[k].name} (${s.val()[k].role})</div>`;
                document.getElementById('st-list').innerHTML = h;
            });
        }
    }

    function printIDCard() {
        window.print();
    }
</script>
</body>
</html>
